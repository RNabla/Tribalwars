/*!
 * 
 *             Script: AllyMembers
 *             Created by: Hermitowski
 *             Version: 2.0.2 (dd82d790d04e2e181b6f4907119ae2b3ed498083)
 *             License: GNU GENERAL PUBLIC LICENSE VERSION 3 https://www.gnu.org/licenses/gpl-3.0.en.html
 *
 *             You can find sources used to built this script here: https://github.com/RNabla/Tribalwars/tree/master/scripts
 *
 */(()=>{"use strict";class e{static handle_error(n,s){if(n instanceof t)UI.ErrorMessage(n.message),n.href&&(location.href=n.href);else{console.error(n);const t=document.createElement("h2");t.textContent="WTF - What a Terrible Failure";const i=document.createElement("textarea");i.rows=12,i.cols=100,i.textContent=n.toString()+"\n\n"+n.stack;const r=document.createElement("a");r.href=s,r.textContent="W\u0105tek na forum";const a=document.createElement("div");a.append(t),a.append(document.createTextNode("Co\u015b posz\u0142o nie tak. Je\u017celi jeste\u015b przekonany/a, \u017ce konfiguracja jest prawid\u0142owa, wklej poni\u017csze zakl\u0119cie na forum wraz z kr\xf3tkim opisem czynno\u015bci, kt\xf3re doprowadzi\u0142y do tej katastrofy")),a.append(document.createElement("br")),a.append(i),a.append(document.createElement("br")),a.append(r),Dialog.show(e.namespace,a.innerHTML)}}static async run(e,t){try{const e=await t();null!=e&&UI.SuccessMessage(e)}catch(t){this.handle_error(t,e)}}}e.namespace="Hermitowski.Bootstrap";class t{constructor(e,t){this.message=e,this.href=t}}class n{createElement(e){return document.createElement(e)}querySelector(e){return document.querySelector(e)}querySelectorAll(e){return document.querySelectorAll(e)}}class s{getGameData(){return window.game_data}buildURL(e,t,n){return TribalWars.buildURL(e,t,n)}async fetchDocument(e,t,n){const s=this.buildURL(e,t,n),i=await fetch(s),r=await i.text(),a=document.createElement("document");return a.innerHTML=r,a}async fetchJSON(e,t,n){const s=this.buildURL(e,t,n),i=await fetch(s);return await i.json()}}class i{constructor(e,t){this.namespace=e,this.resources=t}create_output_panel(e,t){const n=document.createElement("div");n.classList.add("vis","vis_item"),n.style.overflowY="auto",n.style.height=t?.height??"200px",n.style.margin="5px";for(const t of e){const e=this.create_node(t);n.append(e)}return n}get_control(e){const t=this.get_id(e).replace(/\./g,"\\.");return document.querySelector(`#${t}`)}get_id(e){return e?`${this.namespace}.${e}`:this.namespace}create_option_label(e,t){const n=document.createElement("th");if(void 0===e){const e=document.createElement("label");e.classList.add("center"),e.setAttribute("for",this.get_id(t.id));const s=this.resources[t.id];e.textContent=s.label,e.title=s.title,n.append(e)}else if("image"===e.type){const t=document.createElement("img");t.setAttribute("id",this.get_id(e.id)),t.setAttribute("src",image_base+e.src),t.setAttribute("alt",e.id),t.style.margin="auto",t.style.display="block",n.append(t)}return n}create_element(e){if("text"==e.type||"checkbox"==e.type){const t=document.createElement("input");return t.type=e.type,t}return document.createElement(e.type)}create_option_input(e){const t=document.createElement("td"),n=document.createElement("span");n.style.display="flex";for(const t of e.inputs){const e=this.create_element(t);if(e.id=this.get_id(t.id),"checkbox"===t.type)e.style.display="block",e.style.margin="auto",e.checked=t.checked;else if("button"===t.type){const n=this.resources[t.id];e.textContent=n.label,e.title=n.title,e.style.marginTop="2px",e.classList.add("btn"),e.addEventListener("click",t.click)}else"select"===t.type&&this.populate_options(e,t.id,t.options);e.disabled=!1,n.append(e)}if(void 0!==e.styles)for(const n in e.styles)t.style.setProperty(n,e.styles[n]);return t.append(n),t}create_control_panel(e){const t=document.createElement("tr"),n=document.createElement("tr");for(const s of e)t.append(this.create_option_label(s.label,s.inputs[0])),n.append(this.create_option_input(s));const s=document.createElement("div"),i=document.createElement("table");return s.classList.add("vis","vis_item"),s.style.margin="5px",s.append(i),i.style.width="100%",i.append(t),i.append(n),s}create_signature_span(e){const t=document.createElement("span"),n=document.createElement("a");return n.setAttribute("href",e),n.textContent="Link do w\u0105tku na forum",t.append(n),t}create_signature_panel(e){const t=document.createElement("div");t.classList.add("vis_item"),t.style.margin="5px";const n=document.createElement("table");n.style.width="100%";const s=document.createElement("tr"),i=document.createElement("td");return n.append(s),s.append(i),i.append(this.create_signature_span(e)),t.append(n),t}create_container(e){const t=document.createElement("div");t.style.padding="0px",t.style.margin="0px 0px 5px 0px",t.setAttribute("id",this.namespace),t.classList.add("vis","vis_item");for(const n of e)t.append(n);document.querySelector("#contentContainer").prepend(t),this.workaround_intialize_titles()}create_dialog(e,t){const n=[];void 0!==t&&void 0!==t.header_name&&n.push(this.create_node({type:"h2",text:t.header_name}));for(const t of e)n.push(this.create_node(t));void 0!==t&&void 0!==t.forum_thread_href&&n.push(this.create_signature_span(t.forum_thread_href)),Dialog.show(this.namespace,(e=>{for(const t of n)t.outerHTML,e[0].append(t)}).bind(this))}get_selected_label(e){const t=this.get_control(e),n=t.value;for(const e of t.options)if(e.value==n)return e.label}create_node(e){const t=document.createElement(e.type);if(void 0!==e.id&&(t.id=this.get_id(e.id)),void 0!==e.classes)for(const n of e.classes)t.classList.add(n);if(void 0!==e.styles)for(const n in e.styles)t.style.setProperty(n,e.styles[n]);if(void 0!==e.attributes)for(const n in e.attributes){const s=e.attributes[n];"for"==n?(t.textContent=this.resources[e.attributes[n]].label,t.title=this.resources[e.attributes[n]].title,t.setAttribute(n,this.get_id(e.attributes[n]))):"src"==n?t.setAttribute("src",image_base+s):t.setAttribute(n,s)}if(void 0!==e.text&&(t.textContent=e.text),"button"==e.type){const n=this.resources[e.id];t.textContent=n.label,t.title=n.title,t.classList.add("btn")}if("legend"==e.type){const n=this.resources[e.id];t.textContent=n.label,t.title=n.title}if("select"==e.type&&this.populate_options(t,e.id,e.options),void 0!==e.childs)for(const n of e.childs){const e=this.create_node(n);t.append(e)}if(void 0!==e.handlers)for(const n in e.handlers)t.addEventListener(n,e.handlers[n]);return t}populate_options(e,t,n){if(Array.isArray(n)){const s=n;e.title=this.resources[t+"_"+s[0]].title,e.addEventListener("change",this.workaround_sync_titles.bind(this));for(const n of s){const s=document.createElement("option"),i=this.resources[t+"_"+n];s.title=i.title,s.text=i.label,s.value=n,e.append(s)}}else{const t=n;for(const n of t.options){const s=document.createElement("option");s.text=n.label,s.value=n.value,t.selected_value==n.value&&(s.selected=!0),e.append(s)}}}workaround_intialize_titles(){UI.init()}workaround_sync_titles(e){const t=e.target;for(const e of t.children)if(e.value==t.value){t.setAttribute("title",e.getAttribute("data-title")),t.dispatchEvent(new Event("tooltip_change"));break}}}const r={FORUM_THREAD_HREF:"https://forum.plemiona.pl/index.php?threads/hermitowscy-cz%C5%82onkowie.128378/",SCRIPT_HEADER:"Hermitowscy Cz\u0142onkowie",ERROR:{NO_ALLY:"Jeste\u015b poza plemieniem",NO_VILLAGES:"Gracz nie posiada wiosek",NO_PERMISSIONS:"Gracz nie udost\u0119pnia informacji",NO_SELECTION:"Wybierz conajmniej jedn\u0105 zak\u0142adk\u0119 do exportu",SKIPPED_PLAYERS:"Pomini\u0119ci gracze",BOT_CHECK:"Wydaje si\u0119, \u017ce wyskoczy\u0142a ochrona botowa. Od\u015bwie\u017c stron\u0119, rozwi\u0105\u017c zagadk\u0119 i spr\xf3buj ponownie"},PROGRESS:{PLAYER_LIST:"Pobieranie listy graczy",PLAYER_TROOPS:"Pobieranie danych graczy ({0}/{1})",TABLE:"Generowanie tabelki"},PLAYER_NO_ACCESS:"(brak dost\u0119pu)",UI:{members_legend:{label:"Opcje exportu",title:"Okre\u015bla z kt\xf3rych zak\u0142adek zebra\u0107 dane"},members_troops:{label:"Wojska",title:""},members_buildings:{label:"Budynki",title:""},members_defense:{label:"Obrona",title:""},status:{label:"",title:""},export:{label:"Export",title:"Rozpoczyna proces zbierania danych"}}};function a(e){return new Promise((t=>setTimeout(t,e)))}class o{constructor(e){this.concurrent_tasks=e,this.failure_sleep=1e3}async wrap_task(e){const t=await e.activator(e.input);return[e.input,t]}async await_all(e,t){const n=[...e],s=[],i=[],r=new Array(e.length).fill(null);for(;n.length||s.length;){for(void 0!==t&&t(n.length+s.length,e.length);n.length&&s.length<this.concurrent_tasks;){const e=n.pop(),t=this.wrap_task(e);i.push(e),s.push(t)}const o=await Promise.race(s);for(let t=0;t<i.length;t++)if(o[0]==i[t].input){for(let l=0;l<e.length;l++)if(e[l]==i[t]){const c=e[l];null!==o[1]?r[l]=o[1]:(await a(this.failure_sleep),n.push(c)),i.splice(t,1),s.splice(t,1);break}break}}return r}}const l=["members_troops","members_buildings","members_defense"];class c{constructor(e,t,n,s){this.document=t,this.tribalwars=n,this.game_data=n.getGameData(),this.ui=s}async main(){if("0"===this.game_data.player.ally)throw new t(r.ERROR.NO_ALLY);return this.create_gui(),null}create_gui(){const e=[{type:"fieldset",childs:[{type:"legend",id:"members_legend"},{type:"table",childs:[this.create_gui_export_option("members_troops"),this.create_gui_export_option("members_buildings"),this.create_gui_export_option("members_defense")]}]},{type:"div",id:"summary",styles:{display:"flex","justify-content":"space-between","align-items":"center"},childs:[{type:"span",id:"status",text:""},{type:"button",id:"export",handlers:{click:this.export.bind(this)},styles:{"margin-top":"2px"}}]}];this.ui.create_dialog(e,{forum_thread_href:r.FORUM_THREAD_HREF,header_name:r.SCRIPT_HEADER})}create_gui_export_option(e){return{type:"tr",childs:[{type:"td",childs:[{type:"input",id:e,attributes:{type:"checkbox"}}]},{type:"td",childs:[{type:"label",attributes:{for:e}}]}]}}async export(){try{this.ui.get_control("export").disabled=!0;const e=this.get_export_options(),t=await this.get_export_info(e),n=await this.fetch_data(t),s=this.merge_member_data(n,e),[i,a]=this.generate_table(t,s,e);this.save_as_file(i.join("\n")),a.length?this.print_progress(r.ERROR.SKIPPED_PLAYERS+"\n"+a.map((e=>`${e.player_name} - ${e.reason}`)).join("\n")):this.print_progress("")}catch(t){e.handle_error(t,r.FORUM_THREAD_HREF)}finally{this.ui.get_control("export").disabled=!1}}async get_export_info(e){this.print_progress(r.PROGRESS.PLAYER_LIST);const t=[];for(const n in e)e[n]?t.push(this.get_player_list(n)):t.push([n,[]]);const n=await Promise.all(t);return Object.fromEntries(n)}async get_player_list(e){const n=await this.tribalwars.fetchDocument("GET","ally",{mode:e}),s=[...n.querySelectorAll("select option")];if(0===s.length)throw new t(r.ERROR.BOT_CHECK);const i=s.map((e=>{const t=!e.disabled,n=e.value;let s=e.label;return s.endsWith(r.PLAYER_NO_ACCESS)&&(s=s.slice(0,s.length-r.PLAYER_NO_ACCESS.length).trim()),{player_id:n,player_name:s,access_granted:t}}));this.ally_name=n.querySelector("h2").innerText;return[e,i.slice(1)]}async fetch_document(e){const n=this.tribalwars.buildURL("GET","ally",{mode:e.mode,player_id:e.player_id}),s=await fetch(n,{redirect:"manual"});if("opaqueredirect"===s.type)return[];if(200===s.status){const n=await s.text(),i=this.document.createElement("body");if(i.innerHTML=n,0===document.querySelector("#content_value").childElementCount)throw new t(r.ERROR.BOT_CHECK);const a=i.querySelector("#ally_content table.vis.w100");if(null==a)return[];if("members_troops"===e.mode)return await this.map_members_troops(a);if("members_buildings"===e.mode)return await this.map_members_buildings(a);if("members_defense"===e.mode)return await this.map_members_defense(a)}return null}async fetch_data(e){const t={},n=[];for(const t of e.members_buildings)t.access_granted&&n.push({input:{player_id:t.player_id,mode:"members_buildings"},activator:this.fetch_document.bind(this)});for(const t of e.members_defense)t.access_granted&&n.push({input:{player_id:t.player_id,mode:"members_defense"},activator:this.fetch_document.bind(this)});for(const t of e.members_troops)t.access_granted&&n.push({input:{player_id:t.player_id,mode:"members_troops"},activator:this.fetch_document.bind(this)});const s=new o(4),i=await s.await_all(n,((e,t)=>{this.print_progress(r.PROGRESS.PLAYER_TROOPS.replace("{0}",(t-e).toString()).replace("{1}",t.toString()))}));for(let e=0;e<n.length;e++){const s=i[e],r=n[e].input;void 0===t[r.player_id]&&(t[r.player_id]={}),t[r.player_id][r.mode]=s}return t}async map_members_troops(e){const t=[],n={incoming:-1,outgoing:-1};for(let t=this.game_data.units.length+1;t<e.rows[0].cells.length;t++)switch(e.rows[0].cells[t].children[0].src.split("/").pop()){case"commands_outgoing.png":n.outgoing=t;break;case"att.png":n.incoming=t}for(let s=1;s<e.rows.length;s++){const i={units:{},coords:null,village_name:null,outgoing:null,incoming:null},r=e.rows[s];i.coords=r.cells[0].innerText.match(/\d+\|\d+/g).pop(),i.village_name=r.cells[0].innerText.trim();for(let e=0;e<this.game_data.units.length;e++)i.units[this.game_data.units[e]]="?"===r.cells[e+2].innerText.trim()?null:Number(r.cells[e+2].innerText);i.outgoing=-1===n.outgoing?null:Number(r.cells[n.outgoing].innerText),i.incoming=-1===n.incoming?null:Number(r.cells[n.incoming].innerText),t.push(i)}return t}async map_members_buildings(e){const t=[],n={};for(let t=2;t<e.rows[0].cells.length;t++)n[t]=e.rows[0].cells[t].children[0].src.split("/").pop().split(".png")[0];this.building_names||(this.building_names=Object.values(n));for(let s=1;s<e.rows.length;s++){const i={buildings:{},village_name:null,coords:null,points:null},r=e.rows[s];i.village_name=r.cells[0].innerText.trim(),i.coords=r.cells[0].innerText.match(/\d+\|\d+/g).pop(),i.points=Number(r.cells[1].innerText.replace(".",""));for(const e in n)i.buildings[n[e]]=Number(r.cells[e].innerText);t.push(i)}return t}async map_members_defense(e){const t=[],n=e.rows[0].cells.length>this.game_data.units.length+2;for(let s=1;s<e.rows.length;s+=2){const i={coords:null,village_name:null},r=e.rows[s],a=e.rows[s+1];i.village_name=r.cells[0].innerText.trim(),i.coords=r.cells[0].innerText.match(/\d+\|\d+/g).pop(),i.incoming=n?Number(r.cells[this.game_data.units.length+2].innerText):null,i.village={},i.transit={};for(let e=0;e<this.game_data.units.length;e++)i.village[this.game_data.units[e]]="?"===r.cells[e+3].innerText.trim()?null:Number(r.cells[e+3].innerText),i.transit[this.game_data.units[e]]="?"===a.cells[e+1].innerText.trim()?null:Number(a.cells[e+1].innerText);t.push(i)}return t}merge_member_data(e,t){const n={};for(const s in e){const i=e[s],r={};for(const e in t){if(!t[e])continue;const n=i[e];for(const e of n)e.coords in r?Object.assign(r[e.coords],e):r[e.coords]=JSON.parse(JSON.stringify(e))}n[s]=r}return n}print_progress(e){this.ui.get_control("status").innerText=e}get_export_options(){const e={};let n=!1;for(const t of l)e[t]=this.ui.get_control(t).checked,n||(n=this.ui.get_control(t).checked);if(!n)throw new t(r.ERROR.NO_SELECTION);return e}merge_member_metadata(e,t){const n={};for(const s of l){if(!t[s])continue;const i=e[s];for(const e of i){if(!(e.player_id in n)){const t={player_id:e.player_id,player_name:e.player_name,access_granted:{}};for(const e of l)t.access_granted[e]=!1;n[e.player_id]=t}n[e.player_id].access_granted[s]=e.access_granted}}return n}generate_table_header(e){const t=["player_name","village_name","coords"];return(e.members_troops||e.members_defense)&&t.push("incoming"),e.members_troops&&(t.push("outgoing"),t.push(...this.game_data.units)),e.members_buildings&&Array.isArray(this.building_names)&&t.push("points",...this.building_names),e.members_defense&&(t.push(...this.game_data.units.map((e=>"village_"+e))),t.push(...this.game_data.units.map((e=>"transit_"+e)))),t}generate_table(e,t,n){this.print_progress(r.PROGRESS.TABLE);const s=this.generate_table_header(n),i=this.merge_member_metadata(e,n),a=[s.join(",")],o=[];for(const e in i){const s=i[e],c=t[e];if(l.filter((e=>n[e])).map((e=>s.access_granted[e])).reduce(((e,t)=>t||e),!1))if(0!==Object.keys(c).length)for(const e in c){const t=[],i=c[e];if(t.push(`"${s.player_name}"`,`"${i.village_name}"`,i.coords),(n.members_troops||n.members_defense)&&t.push(null!==i.incoming?i.incoming:""),n.members_troops)if(t.push(null!==i.outgoing?i.outgoing:""),s.access_granted.members_troops)for(const e of this.game_data.units)t.push(null!==i.units[e]?i.units[e]:"");else t.push(...new Array(this.game_data.units.length).fill(""));if(n.members_buildings&&Array.isArray(this.building_names))if(s.access_granted.members_buildings){t.push(i.points);for(const e of this.building_names)t.push(i.buildings[e])}else t.push(""),t.push(...new Array(this.building_names.length).fill(""));if(n.members_defense)if(s.access_granted.members_defense)for(const e of["village","transit"])for(const n of this.game_data.units)t.push(null!==i[e][n]?i[e][n]:"");else t.push(...new Array(2*this.game_data.units.length).fill(""));a.push(t.join(","))}else o.push({player_name:s.player_name,reason:r.ERROR.NO_VILLAGES});else o.push({player_name:s.player_name,reason:r.ERROR.NO_PERMISSIONS})}return[a,o]}save_as_file(e){const t=this.document.createElement("a"),n=(new Date).toISOString().replace("T","_").replace(":","-").slice(0,16);t.download=`${this.ally_name}_${n}.csv`,t.href=window.URL.createObjectURL(new Blob([e],{type:"text/csv"})),document.body.appendChild(t),t.click(),document.body.removeChild(t)}}!async function(){await e.run(r.FORUM_THREAD_HREF,(async()=>{const e="Hermitowski.AllyMembers",t=new n,a=new s,o=new i(e,r.UI),l=new c(e,t,a,o);return await l.main()}))}()})();