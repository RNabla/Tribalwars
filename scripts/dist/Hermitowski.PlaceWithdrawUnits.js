/*!
 * 
 *             Script: PlaceWithdrawUnits
 *             Created by: Hermitowski
 *             Version: 1.0.1 (eb04ed8d4c2e4cc620182c0e5d94a0440f9f67ab)
 *             License: GNU GENERAL PUBLIC LICENSE VERSION 3 https://www.gnu.org/licenses/gpl-3.0.en.html
 *
 *             You can find sources used to built this script here: https://github.com/RNabla/Tribalwars/tree/master/scripts
 *
 */(()=>{"use strict";class e{static handle_error(a,n){if(a instanceof t)UI.ErrorMessage(a.message),a.href&&(location.href=a.href);else{console.error(a);const t=document.createElement("h2");t.textContent="WTF - What a Terrible Failure";const r=document.createElement("textarea");r.rows=12,r.cols=100,r.textContent=a.toString()+"\n\n"+a.stack;const i=document.createElement("a");i.href=n,i.textContent="W\u0105tek na forum";const s=document.createElement("div");s.append(t),s.append(document.createTextNode("Co\u015b posz\u0142o nie tak. Je\u017celi jeste\u015b przekonany/a, \u017ce konfiguracja jest prawid\u0142owa, wklej poni\u017csze zakl\u0119cie na forum wraz z kr\xf3tkim opisem czynno\u015bci, kt\xf3re doprowadzi\u0142y do tej katastrofy")),s.append(document.createElement("br")),s.append(r),s.append(document.createElement("br")),s.append(i),Dialog.show(e.namespace,s.innerHTML)}}static async run(e,t){try{const e=await t();null!=e&&UI.SuccessMessage(e)}catch(t){this.handle_error(t,e)}}}e.namespace="Hermitowski.Bootstrap";class t{constructor(e,t){this.message=e,this.href=t}}class a{createElement(e){return document.createElement(e)}querySelector(e){return document.querySelector(e)}querySelectorAll(e){return document.querySelectorAll(e)}}class n{getGameData(){return window.game_data}buildURL(e,t,a){return TribalWars.buildURL(e,t,a)}async fetchDocument(e,t,a){const n=this.buildURL(e,t,a),r=await fetch(n),i=await r.text(),s=document.createElement("document");return s.innerHTML=i,s}async fetchJSON(e,t,a){const n=this.buildURL(e,t,a),r=await fetch(n);return await r.json()}}const r="https://forum.plemiona.pl/index.php?threads/cofanie-wspieraj%C4%85cych-wojsk-z-poziomu-placu.126686/";class i{constructor(e,t,a){this.namespace=e,this.document=t,this.tribalwars=a,this.game_data=a.getGameData(),this.cell_handler=this.handler.bind(this)}async main(){if("place"!==this.game_data.screen||"units"!==this.game_data.mode){const e=this.tribalwars.buildURL("GET","place",{mode:"units"});throw new t("Przechodz\u0119 do przegl\u0105du placu",e)}const e=this.scan_defense_table(),a=this.scan_support_table();if(e||a)return"Kliknij podkre\u015blon\u0105 kom\xf3rk\u0119, aby wycofa\u0107 dany typ wojska";throw new t("Brak w\u0142asnych wojsk do zarz\u0105dzania")}scan_defense_table(){const e=this.document.querySelector('form[action*="command_other"] > table');if(null==e)return!1;let t=!1;for(let a=2;a<e.rows.length-2;a++){const n=e.rows[a],r=n.querySelector("[data-player]").getAttribute("data-player"),i=n.querySelector("[data-id]").getAttribute("data-id"),s=n.querySelector('input[name^="id_"').getAttribute("name").substring(3);if(r==this.game_data.player.id.toString())for(let e=0;e<this.game_data.units.length;e++){const a=n.cells[e+3],r={unit_id:this.game_data.units[e],unit_count:Number(a.innerText),away_id:s,village_id:i};this.add_handler(a,r)&&(t=!0)}}return t}scan_support_table(){const e=this.document.querySelector('form[action*="withdraw_selected_unit_counts"] > table');if(null==e)return!1;for(let t=1;t<e.rows.length-1;t++){const a=e.rows[t],n=a.querySelector("[data-away-id]").getAttribute("data-away-id");for(let e=0;e<a.cells.length;e++){const t=a.cells[e],r={unit_id:t.getAttribute("id"),unit_count:Number(t.innerText),away_id:n,village_id:this.game_data.village.id.toString()};this.add_handler(t,r)}}return!0}add_handler(e,t){return!(!t.unit_id||0==t.unit_count||(e.style.cursor="pointer",e.style.textDecoration="underline",e.dataset[this.namespace]=JSON.stringify(t),e.addEventListener("click",this.cell_handler),0))}async handler(t){try{const e=t.target;e.removeEventListener("click",this.cell_handler);const a=JSON.parse(e.dataset[this.namespace]),n=this.tribalwars.buildURL("POST","place",{action:"withdraw_selected_unit_counts",mode:"units",village:a.village_id,h:this.game_data.csrf});await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:encodeURI(`withdraw_unit[${a.away_id}][${a.unit_id}]=${a.unit_count}`)}),e.style.cursor=null,e.style.textDecoration=null,e.innerText="0",e.classList.add("hidden")}catch(t){e.handle_error(t,r)}}}!async function(){await e.run(r,(async()=>{const e=new a,t=new n,r=new i("Hermitowski.PlaceWithdrawUnits",e,t);return await r.main()}))}()})();