/*!
 * 
 *             Script: Faking
 *             Created by: Hermitowski
 *             Version: 4.2.7 (a7d2f49a39f2ce777d7741123d6124e745e1f17e)
 *             License: GNU GENERAL PUBLIC LICENSE VERSION 3 https://www.gnu.org/licenses/gpl-3.0.en.html
 *
 *             You can find sources used to built this script here: https://github.com/RNabla/Tribalwars/tree/master/scripts
 *
 */(()=>{"use strict";class t{static create_instance(t,a){a(new e(t))}}class e{constructor(t){this.namespace=t,this.base_stack=(new Error).stack.split("\n").slice(1),this.style="color: green;",this.timers=new Map}get_stack_trace(){const t=(new Error).stack.split("\n").slice(2),e=[`%c${this.namespace}`];for(let a=1;a<=t.length;a++)if(this.base_stack.length-a<0||this.base_stack.length-a>=0&&t[t.length-a]!=this.base_stack[this.base_stack.length-a]){const s=this.get_frame_name(t[t.length-a]);s.length>0&&e.push(s)}return e.push(""),e}get_frame_name(t){let e=t.split("@")[0];const a=e.split("async*");return a.length>1&&(e=a[1]),e=e.trim(),e}entry(...t){const e=this.get_stack_trace(),a=this.get_frame_name(e[0]);this.timers.set(a,Date.now()),console.group.apply(void 0,[e.join(" | "),this.style,"Entry",...t])}log(...t){const e=this.get_stack_trace();console.log.apply(void 0,[e.join(" | "),this.style,...t])}exit(...t){const e=this.get_stack_trace(),a=this.get_frame_name(e[0]),s=this.timers.get(a),i=[e.join(" | "),this.style,`Exit | Elapsed time: ${Date.now()-s} [ms]`];t.length>0&&(i.push("|"),i.push(t[0])),console.log.apply(void 0,i),console.groupEnd()}}async function a(t){"string"!=typeof t&&(t=JSON.stringify(t));const e=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(a)).map((t=>t.toString(16).padStart(2,"0"))).join("")}function s(t){return t<10?`0${t}`:`${t}`}async function i(t){const e=new Promise(((e,a)=>{t.onsuccess=function(t){e(t.target.result)},t.onerror=function(t){a(t)}}));return await e}const n="storage",r="name",o="expiration_time_s",_="readwrite",l="readonly";class c{constructor(e,a){this.data_provider=e,this.database=a,t.create_instance("Storage",(t=>{this.logger=t}))}static async get_item_name(t,e){return t+"."+("string"==typeof e?e:await a(e))}async get_item(t,e){const a=await c.get_item_name(t,e),s=await i(this.database.transaction(n,l).objectStore(n).get(a));return this.data_provider.get_current_timestamp_s(),s&&s.expiration_time_s>this.data_provider.get_current_timestamp_s()?s:null}async set_item(t,e,a,s){const r={name:await c.get_item_name(t,e),expiration_time_s:this.data_provider.get_current_timestamp_s()+s,value:a};await i(this.database.transaction(n,_).objectStore(n).put(r))}async get_or_add_item(t,e,a){const s=await c.get_item_name(t,e);let r=await i(this.database.transaction(n,l).objectStore(n).get(s));return(!r||r.expiration_time_s<this.data_provider.get_current_timestamp_s())&&(r=await a(),r.name=s,await i(this.database.transaction(n,_).objectStore(n).put(r))),r.name=s,r}async get_or_compute_dynamic(t,e,s,i){const n=await a(e.toString()+JSON.stringify(s));return(await this.get_or_add_item(t,n,(async()=>{const t=await e(s);return{name:"",expiration_time_s:this.data_provider.get_current_timestamp_s()+i,value:t}}))).value}}var u;!function(t){t.config="config",t.building_info="building_info",t.unit_info="unit_info",t.village="village",t.player="player",t.ally="ally"}(u||(u={}));class g{constructor(e,a,s){t.create_instance(e,(t=>{this.logger=t})),this.user_namespace=e,this.storage=a,this.data_provider=s,this.regex=new RegExp(/\+/,"g")}async get_world_info_core(t){const e=[];for(const a of t){const t=this.storage.get_or_add_item(g.namespace,a.toString(),(async()=>await this.fetch_from_server(a)));e.push(t)}const a=await Promise.all(e),s={};for(let e=0;e<t.length;e++)s[t[e]]=a[e];return s}async fetch_from_server(t){switch(t){case u.village:return await this.fetch_from_server_map_files("village",(function(t){return{id:t[0],x:parseInt(t[2]),y:parseInt(t[3]),player_id:t[4]}}));case u.player:return await this.fetch_from_server_map_files("player",(function(t){return{id:t[0],name:t[1],ally_id:t[2]}}));case u.ally:return await this.fetch_from_server_map_files("ally",(function(t){return{id:t[0],name:t[1],tag:t[2]}}));case u.building_info:return await this.fetch_from_server_config("building_info");case u.unit_info:return await this.fetch_from_server_config("unit_info");case u.config:return await this.fetch_from_server_config("config")}}async fetch_from_server_map_files(t,e){const a=await fetch(`map/${t}.txt`),s=new Date(a.headers.get("last-modified")),i=(await a.text()).split("\n").filter((t=>t.trim().length>0)).map((t=>t.split(",").map((t=>this.decode(t))))),n=[];for(const t of i)n.push(e(t));let r=(o=s,Math.floor(o.getTime()/1e3)+3600+this.data_provider.get_random_number(15,120));for(var o;r<this.data_provider.get_current_timestamp_s();)r=this.data_provider.get_current_timestamp_s()+3600;return{name:"",expiration_time_s:r,value:n}}async fetch_from_server_config(t){const e=await fetch(`interface.php?func=get_${t}`),a=await e.text(),s=this.get_json_from_xml_string(a);return{name:"",expiration_time_s:this.data_provider.get_current_timestamp_s()+3600,value:s}}decode(t){return decodeURIComponent(t.replace(this.regex," "))}get_json_from_xml_string(t){const e=(new window.DOMParser).parseFromString(t,"text/xml");return this.convert_xml_to_json(e.children[0])}convert_xml_to_json(t){const e={};for(const a of t.children)e[a.nodeName]=0===a.childElementCount?a.textContent:this.convert_xml_to_json(a);return e}convert_to_world_info(t){return{village:t.village?.value,player:t.player?.value,ally:t.ally?.value,config:t.config?.value,building_info:t.building_info?.value,unit_info:t.unit_info?.value}}async get_world_info(t){const e=await this.get_world_info_core(t);return this.convert_to_world_info(e)}async get_item(t){const e=await this.storage.get_item(this.user_namespace,t);return e?e.value:null}async set_item(t,e,a){return await this.storage.set_item(this.user_namespace,t,e,a)}async get_or_compute(t,e,s){const i="string"==typeof s?s:await a(s);return(await this.storage.get_or_add_item(this.user_namespace,i,(async()=>{const a=await this.get_world_info_core(e),i=this.convert_to_world_info(a),n=await t(i,"string"==typeof s?void 0:s);return{name:"",expiration_time_s:Math.min(...e.map((t=>a[t].expiration_time_s))),value:n}}))).value}async get_or_compute_dynamic(t,e,a){return this.storage.get_or_compute_dynamic(this.user_namespace,t,e,a)}}g.namespace="Hermitowski.MapFiles";const p={TROOPS_SELECTED:"Wybrano tylko wojsko",TROOPS_AND_TARGET_SELECTED:"Wojsko dojdzie __DAY__.__MONTH__ na __HOURS__:__MINUTES__<br/>Cel: __TARGET__ __PLAYER_INFO__",ERROR_FORUM_CONFIG_THREAD_ID:"forum_config.thread_id jest nieprawid\u0142owy",ERROR_FORUM_CONFIG_SPOILER_NAME:"forum_config.spoiler_name jest nieprawid\u0142owy",ERROR_FORUM_CONFIG_TTL:"forum_config.ttl jest nieprawid\u0142owy",ERROR_FORUM_CONFIG_PAGE:"forum_config.page jest nieprawid\u0142owy",ERROR_FORUM_CONFIG_SPOILER_NONE:"Nie znaleziono spoilera o podanej nazwie. Upewnij si\u0119, \u017ce thread_id, page, spoiler_name s\u0105 poprawnie skonfigurowane",ERROR_FORUM_CONFIG_SPOILER_MULTIPLE:"Znaleziono wi\u0119cej ni\u017c jeden spoiler o podanej nazwie",ERROR_FORUM_CONFIG_CODE_SNIPPET_NONE:"Wskazany spoiler nie zawiera konfiguracji",ERROR_FORUM_CONFIG_CODE_SNIPPET_MULTIPLE:"Wskazany spoiler zawiera wi\u0119cej ni\u017c jedn\u0105 konfiguracj\u0119",ERROR_FORUM_CONFIG_CODE_SNIPPET_MALFORMED:"Wskazany spoiler nie zawiera konfiguracji w formacie JSON",ERROR_SCREEN_VILLAGE_OUT_OF_GROUP:"Wioska poza grup\u0105. Przechodz\u0119 do nast\u0119pnej wioski z grupy",ERROR_SCREEN_REDIRECT:"Przechodz\u0119 do przegl\u0105du placu",ERROR_SCREEN_NO_ACTION:"Na tym ekranie nie ma akcji do wykonania",ERROR_CONFIGURATION_MISSING:"Brak konfiguracji u\u017cytkownika",ERROR_CONFIGURATION_OPTION_UNKNOWN:"Skrypt zawiera nieznan\u0105 opcj\u0119",ERROR_TROOPS_NOT_ENOUGH:"Nie uda\u0142o si\u0119 wybra\u0107 wystarczaj\u0105cej liczby jednostek",ERROR_TROOPS_EMPTY_SELECTION:"Wybrane szablony nie pozwalaj\u0105 na wyb\xf3r jednostek",ERROR_TROOPS_EMPTY_TEMPLATES:"Nie wybrano szablon\xf3w z wyborem jednostek",ERROR_POOL_EMPTY:"Obecne ustawienia nie definuj\u0105 \u017cadnych cel\xf3w",ERROR_POOL_EMPTY_SNOBS:"W puli wiosek pozosta\u0142y wioski, le\u017c\u0105ce poza zasi\u0119giem szlachcic\xf3w",ERROR_POOL_EMPTY_BLOCKED_VILLAGES:"W puli wiosek pozosta\u0142y wioski, kt\xf3re zosta\u0142y niedawno wybrane",ERROR_POOL_EMPTY_BLOCKED_PLAYERS:"W puli wiosek pozosta\u0142y wioski, kt\xf3re nale\u017c\u0105 od ostatnio wybranych graczy",ERROR_POOL_EMPTY_NIGHT_BONUS:"W puli wiosek pozosta\u0142y wioski, na kt\xf3re atak doszed\u0142by w bonusie nocnym",ERROR_POOL_EMPTY_DATE_RANGES:"W puli wiosek pozosta\u0142y wioski, na kt\xf3re atak doszed\u0142by poza wybranymi przedzia\u0142ami czasowymi"};class d{static handle_error(t,e){if(t instanceof h)UI.ErrorMessage(t.message),t.href&&(location.href=t.href);else{console.error(t);const a=document.createElement("h2");a.textContent="WTF - What a Terrible Failure";const s=document.createElement("textarea");s.rows=12,s.cols=100,s.textContent=t.toString()+"\n\n"+t.stack;const i=document.createElement("a");i.href=e,i.textContent="W\u0105tek na forum";const n=document.createElement("div");n.append(a),n.append(document.createTextNode("Co\u015b posz\u0142o nie tak. Je\u017celi jeste\u015b przekonany/a, \u017ce konfiguracja jest prawid\u0142owa, wklej poni\u017csze zakl\u0119cie na forum wraz z kr\xf3tkim opisem czynno\u015bci, kt\xf3re doprowadzi\u0142y do tej katastrofy")),n.append(document.createElement("br")),n.append(s),n.append(document.createElement("br")),n.append(i),Dialog.show(d.namespace,n.innerHTML)}}static async run(t,e){try{const t=await e();null!=t&&UI.SuccessMessage(t)}catch(e){this.handle_error(e,t)}}}d.namespace="Hermitowski.Bootstrap";class h{constructor(t,e){this.message=t,this.href=e}}class m{constructor(e,a,s,i){t.create_instance("Hermitowski.Faking.TroopsSelector",(t=>{this.logger=t})),this.document=e,this.settings=i,this.world_info=a,this.game_data=s,this.selectable_unit_names=s.units.filter((t=>"militia"!==t))}select_troops(){if(0==this.settings.troops_templates.length)throw new h(p.ERROR_TROOPS_EMPTY_TEMPLATES);const t=this.get_available_troops();for(const e of this.settings.troops_templates){const a=this.try_fill_troops(t,e);if(a)return a}throw new h(p.ERROR_TROOPS_NOT_ENOUGH)}try_fill_troops(t,e){const a=JSON.parse(JSON.stringify(e));for(const e in a)if(t[e]<a[e])return a[e],t[e],null;const s=Number(this.world_info.config.game.fake_limit);if(0==s)return a;if(5==a.spy&&Object.keys(a).filter((t=>"spy"!==t)).every((t=>0==a[t])))return a;const i=Math.floor(this.game_data.village.points*s*.01),n=this.count_population(a);for(const t of this.selectable_unit_names)Object.prototype.hasOwnProperty.call(a,t)||(a[t]=0);const r=this.settings.fill_troops.split(",");let o=i-n;for(const e of r){const s=e.split(":"),i=s[0];if(!this.selectable_unit_names.includes(i))continue;const n=Number(this.world_info.unit_info[i].pop),r=[t[i]-a[i]];s.length>1&&r.push(Number(s[1])),this.settings.fill_exact||r.push(Math.ceil(o/n));const _=Math.min(...r);_>0&&(a[i]+=_,o-=n*_)}return o<=0?a:null}get_available_troops(){const t={};for(const e of this.selectable_unit_names)t[e]=Number(this.document.querySelector(`#unit_input_${e}`).dataset.allCount),Object.prototype.hasOwnProperty.call(this.settings.safeguard,e)&&(t[e]=Math.max(0,t[e]-this.settings.safeguard[e]));return t}count_population(t){return Object.keys(t).map((e=>t[e]*Number(this.world_info.unit_info[e].pop))).reduce(((t,e)=>t+e),0)}}class f{constructor(e,a){t.create_instance("Hermitowski.Faking.Targets.Pool",(t=>{this.logger=t})),this.settings=a,this.map_files=e}async pool_get(){const t={allies:this.settings.allies,ally_tags:this.settings.ally_tags,ally_ids:this.settings.ally_ids,players:this.settings.players,player_ids:this.settings.player_ids,exclude_allies:this.settings.exclude_allies,exclude_ally_tags:this.settings.exclude_ally_tags,exclude_ally_ids:this.settings.exclude_ally_ids,exclude_players:this.settings.exclude_players,exclude_player_ids:this.settings.exclude_player_ids,include_barbarians:this.settings.include_barbarians,boundaries_box:this.settings.boundaries_box,boundaries_circle:this.settings.boundaries_circle,coords:this.settings.coords},e=await this.map_files.get_or_compute((async(t,e)=>{const a=e.players.split(",").map((t=>t.trim().toLowerCase())),s=e.player_ids.split(",").map((t=>t.trim())),i=e.allies.split(",").map((t=>t.trim().toLowerCase())),n=e.ally_tags.split(",").map((t=>t.trim().toLowerCase())),r=e.ally_ids.split(",").map((t=>t.trim())),o=e.exclude_players.split(",").map((t=>t.trim().toLowerCase())),_=e.exclude_player_ids.split(",").map((t=>t.trim())),l=e.exclude_allies.split(",").map((t=>t.trim().toLowerCase())),c=e.exclude_ally_tags.split(",").map((t=>t.trim().toLowerCase())),u=e.exclude_ally_ids.split(",").map((t=>t.trim())),g=new Set(t.ally.filter((t=>i.includes(t.name.toLowerCase())||n.includes(t.tag.toLowerCase())||r.includes(t.id))).map((t=>t.id))),p=new Set(t.ally.filter((t=>l.includes(t.name.toLowerCase())||c.includes(t.tag.toLowerCase())||u.includes(t.id))).map((t=>t.id))),d=new Set(t.player.filter((t=>(a.includes(t.name.toLowerCase())||s.includes(t.id)||g.has(t.ally_id))&&!p.has(t.ally_id))).map((t=>t.id))),h=new Set(t.player.filter((t=>o.includes(t.name.toLowerCase())||_.includes(t.id)||p.has(t.ally_id))).map((t=>t.id))),m=[];let f=t.village.filter((t=>e.include_barbarians&&t.player_id===O||d.has(t.player_id)&&!h.has(t.player_id)));e.boundaries_box.length&&(f=f.filter((t=>this.is_in_any_boundary_box(t,e.boundaries_box)))),e.boundaries_circle.length&&(f=f.filter((t=>this.is_in_any_boundary_circle(t,e.boundaries_circle))));for(const e of f){const a=this.get_village_as_target(t,e);m.push(a)}const y=new RegExp(/\d{1,3}\|\d{1,3}(:\d+)?/g),w=e.coords.match(y);if(null!=w)for(const e of w.map((t=>t.split(":")))){let a=1;2==e.length&&(a=Number(e[1]));const s=e[0].split("|").map(Number),i=t.village.find((t=>t.x==s[0]&&t.y==s[1]));if(i){const e=this.get_village_as_target(t,i);if(h.has(e[2]))continue;for(let t=0;t<a;t++)m.push(e)}}return m}),[u.ally,u.player,u.village],t);if(this.has_non_empty_settings()&&0===e.length)throw new h(p.ERROR_POOL_EMPTY);return e}has_non_empty_settings(){return"false"!=""+this.settings.allies+this.settings.ally_tags+this.settings.ally_ids+this.settings.players+this.settings.player_ids+this.settings.exclude_allies+this.settings.exclude_ally_tags+this.settings.exclude_ally_ids+this.settings.exclude_players+this.settings.exclude_player_ids+this.settings.include_barbarians+this.settings.boundaries_box+this.settings.boundaries_circle+this.settings.coords}get_village_as_target(t,e){const a=e.player_id!==O?t.player.find((t=>t.id==e.player_id)):null,s=null!=a&&a.ally_id!==R?t.ally.find((t=>t.id==a.ally_id)):null,i=a?a.name:null,n=s?s.tag:null;return[e.x,e.y,e.player_id,i,n]}is_in_any_boundary_box(t,e){for(const a of e)if(a.min_x<=t.x&&t.x<=a.max_x&&a.min_y<=t.y&&t.y<=a.max_y)return!0;return!1}is_in_any_boundary_circle(t,e){for(const a of e){const e=a.x-t.x,s=a.y-t.y;if(e*e+s*s<=a.r*a.r)return!0}return!1}}class y{static calculate_distance(t,e){return Math.hypot(t.village.x-e[0],t.village.y-e[1])}static calculate_arrival_time(t,e,a,s){const i=y.calculate_distance(t,e);return new Date(1e3*(s+i*a*60))}static get_troops_speed(t,e){let a=0;for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&0!==e[s]&&(a=Math.max(Number(t.unit_info[s].speed),a));if(0===a)throw new h(p.ERROR_TROOPS_EMPTY_SELECTION);return a}}class w{constructor(e,a,s,i){t.create_instance("Hermitowski.Faking.Targets.DateRangeFilter",(t=>{this.logger=t})),this.world_info=e,this.game_data=s,this.data_provider=a,this.settings=i,this.timestamp_s=this.data_provider.get_current_timestamp_s()}apply_filter(t,e){const a=y.get_troops_speed(this.world_info,e);return t=this.apply_night_bonus(t,e,a),this.apply_date_ranges(t,a)}apply_night_bonus(t,e,a){const s=Object.keys(e).filter((t=>"spy"!==t)).every((t=>0==e[t]));if("1"===this.world_info.config.night.active&&this.settings.skip_night_bonus&&!s){const e=Number(this.world_info.config.night.start_hour),s=Number(this.world_info.config.night.end_hour);if(0===(t=t.filter((t=>{if(t[2]===O)return!0;const i=y.calculate_arrival_time(this.game_data,t,a,this.timestamp_s).getHours();return e<s&&0==e?i>=s:e<s?i>s&&i<e:e>s&&0==s?i<e:i<e&&i>=s}))).length)throw new h(p.ERROR_POOL_EMPTY_NIGHT_BONUS)}return t}apply_date_ranges(t,e){if(this.settings.date_ranges.length>0){const a=t;for(const s of this.settings.date_ranges){let i=null;if(-1!=s[0][0]&&-1!=s[1][0]){const t=new Date(s[0][2],s[0][1]-1,s[0][0],s[0][3],s[0][4]),a=new Date(s[1][2],s[1][1]-1,s[1][0],s[1][3],s[1][4]);i=s=>{const i=y.calculate_arrival_time(this.game_data,s,e,this.timestamp_s);return t<=i&&i<=a}}else{const t=this.get_minutes(s[0]),a=this.get_minutes(s[1]);i=s=>{const i=y.calculate_arrival_time(this.game_data,s,e,this.timestamp_s),n=this.get_minutes([-1,-1,-1,i.getHours(),i.getMinutes()]);return t<=n&&n<=a}}if((t=a.filter(i)).length>0)break}if(0==t.length)throw new h(p.ERROR_POOL_EMPTY_DATE_RANGES)}return t}get_minutes(t){return 60*t[3]+t[4]}}class b{constructor(e,a,s,i){t.create_instance("Hermitowski.Faking.Targets.PoolBlocker",(t=>{this.logger=t})),this.map_files=e,this.game_data=s,this.data_provider=a,this.settings=i}async apply_blocking(t){return t=await this.pool_apply_blocking_local(t),await this.pool_apply_blocking_global(t)}async add_to_block_tables(t){this.settings.blocking_local&&await this.block_table_add_entry(t,this.blocking_local_get_key(),this.settings.blocking_local.time_s);for(const e of this.settings.blocking_global)await this.block_table_add_entry(t,this.blocking_global_get_key(e.name),e.time_s)}async pool_apply_blocking_local(t){return this.settings.blocking_local&&(t=await this.pool_apply_block_table(t,this.blocking_local_get_key(),this.settings.blocking_local.count,this.settings.blocking_local.block_players)),t}async pool_apply_blocking_global(t){for(const e of this.settings.blocking_global)t=await this.pool_apply_block_table(t,this.blocking_global_get_key(e.name),e.count,e.block_players);return t}blocking_local_get_key(){return"instance"===this.settings.blocking_local.scope?{village_id:this.game_data.village.id,settings:this.settings}:`blocking.l.${this.game_data.village.id}`}blocking_global_get_key(t){return`blocking.g.${t}`}async pool_apply_block_table(t,e,a,s){const i=await this.block_table_get(e),n=new Map,r=new Map,o=function(t){return 1e3*t[0]+t[1]};for(const t of i){const e=o(t[1]);if(n.has(e)?n.set(e,n.get(e)+1):n.set(e,1),s){const e=t[1][2];e!=O&&(r.has(e)?r.set(e,r.get(e)+1):r.set(e,1))}}if(s){if(0===(t=t.filter((t=>{const e=t[2];return(r.get(e)||0)<a}))).length)throw new h(p.ERROR_POOL_EMPTY_BLOCKED_PLAYERS)}else if(0===(t=t.filter((t=>{const e=o(t);return(n.get(e)||0)<a}))).length)throw new h(p.ERROR_POOL_EMPTY_BLOCKED_VILLAGES);return t}async block_table_get(t){let e=await this.map_files.get_item(t)||[];const a=this.data_provider.get_current_timestamp_s();let s=0;for(;s<e.length&&!(e[s][0]>=a);s++);return s==e.length?e=[]:s>0&&(e=e.slice(s)),e}async block_table_add_entry(t,e,a){const s=await this.block_table_get(e),i=[this.data_provider.get_current_timestamp_s()+a,[t[0],t[1],t[2]]];s.push(i),await this.map_files.set_item(e,s,a)}}const O="0",R="0";class E{constructor(e,a,s,i,n){t.create_instance("Hermitowski.Faking.TargetSelector",(t=>{this.logger=t})),this.settings=n,this.world_info=e,this.map_files=a,this.data_provider=s,this.game_data=i}async select_target(t){const e=new f(this.map_files,this.settings);let a=await e.pool_get();if(0===a.length)return null;a=await this.pool_apply_troops_constraints(a,t);let s=null;this.settings.blocking_enabled&&(s=new b(this.map_files,this.data_provider,this.game_data,this.settings),a=await s.apply_blocking(a)),a=new w(this.world_info,this.data_provider,this.game_data,this.settings).apply_filter(a,t);const i=a[this.data_provider.get_random_number(0,a.length)],n=y.get_troops_speed(this.world_info,t);this.settings.blocking_enabled&&s.add_to_block_tables(i);return{x:i[0],y:i[1],player_name:i[3],ally_tag:i[4],arrival_date:y.calculate_arrival_time(this.game_data,i,n,this.data_provider.runtime_timestamp_s)}}pool_apply_troops_constraints(t,e){if(e.snob>0&&0===(t=t.filter((t=>y.calculate_distance(this.game_data,t)<Number(this.world_info.config.snob.max_dist)))).length)throw new h(p.ERROR_POOL_EMPTY_SNOBS);return t}}class k{static map_configuration(t){return{safeguard:k.as_troops(t.safeguard),troops_templates:k.as_array(t.troops_templates,k.as_troops,[{spy:1,ram:1},{spy:1,catapult:1},{ram:1},{catapult:1}]),fill_exact:k.as_boolean(t.fill_exact,!1),fill_troops:k.as_string(t.fill_troops,"spear,sword,axe,archer,spy,light,marcher,heavy,ram,catapult"),coords:k.as_string(t.coords,""),players:k.as_string(t.players,""),player_ids:k.as_string(t.player_ids,""),allies:k.as_string(t.allies,""),ally_tags:k.as_string(t.ally_tags,""),ally_ids:k.as_string(t.ally_ids,""),exclude_players:k.as_string(t.exclude_players,""),exclude_player_ids:k.as_string(t.exclude_player_ids,""),exclude_allies:k.as_string(t.exclude_allies,""),exclude_ally_tags:k.as_string(t.exclude_ally_tags,""),exclude_ally_ids:k.as_string(t.exclude_ally_ids,""),include_barbarians:k.as_boolean(t.include_barbarians,!1),boundaries_circle:k.as_array(t.boundaries,k.as_boundary_circle),boundaries_box:k.as_array(t.boundaries,k.as_boundary_box),blocking_enabled:k.as_boolean(t.blocking_enabled,!1),blocking_local:k.as_blocking_local(t.blocking_local,null),blocking_global:k.as_array(t.blocking_global,k.as_blocking_global),skip_night_bonus:k.as_boolean(t.skip_night_bonus,!0),date_ranges:k.as_array(t.date_ranges,k.as_date_range),changing_village_enabled:k.as_boolean(t.changing_village_enabled,!0)}}static as_string(t,e){return"string"==typeof t?t:e}static as_number(t,e){if("number"==typeof t)return t;if("string"==typeof t){const e=Number(t);if(!isNaN(e))return e}return e}static as_troops(t){const e={};if("object"==typeof t)for(const a of["spear","sword","axe","archer","spy","light","marcher","heavy","ram","catapult","knight","snob"])if(Object.prototype.hasOwnProperty.call(t,a)){const s=k.as_number(t[a],null);null!=s&&(e[a]=s)}return e}static as_array(t,e,a=null){if(Array.isArray(t)){const a=[];for(let s=0;s<t.length;s++){const i=e(t[s]);null!=i&&a.push(i)}return a}return null!=a?a:[]}static as_boolean(t,e){return"boolean"==typeof t?t:"string"==typeof t?"true"===t.trim().toLowerCase():e}static as_boundary_circle(t){if("object"==typeof t){const e=k.as_number(t.x,null),a=k.as_number(t.y,null),s=k.as_number(t.r,null);if(null!=e&&null!=a&&null!=s)return{x:e,y:a,r:s}}return null}static as_boundary_box(t){if("object"==typeof t){const e=k.as_number(t.min_x,null),a=k.as_number(t.max_x,null),s=k.as_number(t.min_y,null),i=k.as_number(t.max_y,null);if(null!=e&&null!=a&&null!=s&&null!=i)return{min_x:e,max_x:a,min_y:s,max_y:i}}return null}static as_date_range_part(t){if("string"==typeof t){const e=t.match(/\d+/g);if(null!=e&&(2===e.length||5===e.length))return[-1,-1,-1,...e.map(Number)].slice(-5)}return null}static as_date_range(t){if("string"==typeof t){const e=t.split("-");if(2===e.length){const t=[k.as_date_range_part(e[0]),k.as_date_range_part(e[1])];if(null!=t[0]&&null!=t[1])return t}}return null}static as_blocking_local(t,e){if("object"==typeof t){const e=k.as_number(t.time_s,null),a=k.as_number(t.count,null),s=k.as_boolean(t.block_players,null),i="instance"===k.as_string(t.scope,null)?"instance":null;if(null!=e&&null!=a&&null!=s)return{time_s:e,count:a,block_players:s,scope:i}}return e}static as_blocking_global(t){if("object"==typeof t){const e=k.as_number(t.time_s,null),a=k.as_number(t.count,null),s=k.as_boolean(t.block_players,null),i=k.as_string(t.name,null);if(null!=e&&null!=a&&null!=s&&null!=i)return{time_s:e,count:a,block_players:s,name:i}}return null}}class x{constructor(e,a){t.create_instance("Hermitowski.Faking.SettingsProvider",(t=>{this.logger=t})),this.tribalwars=e,this.map_files=a}async get_settings(t){if("object"!=typeof t)throw new h(p.ERROR_CONFIGURATION_MISSING);const e=this.try_get_forum_config(t.forum_config);return null!=e&&(t=await this.load_config_from_forum(e)),k.map_configuration(t)}try_get_forum_config(t){if("object"==typeof t){const e=k.as_number(t.thread_id,null);if(null==e)throw new h(p.ERROR_FORUM_CONFIG_THREAD_ID);const a=k.as_string(t.spoiler_name,null);if(null==a)throw new h(p.ERROR_FORUM_CONFIG_SPOILER_NAME);return{thread_id:e,page:k.as_number(t.page,0),spoiler_name:a,time_to_live_s:k.as_number(t.time_to_live_s,3600)}}return null}async load_config_from_forum(t){return await this.map_files.get_or_compute_dynamic((async t=>{const e=(await this.tribalwars.fetchDocument("GET","forum",{screenmode:"view_thread",thread_id:t.thread_id,page:t.page})).querySelectorAll(`div.spoiler > input[value="${t.spoiler_name}"]`);if(0==e.length)throw new h(p.ERROR_FORUM_CONFIG_SPOILER_NONE);if(e.length>1)throw new h(p.ERROR_FORUM_CONFIG_SPOILER_MULTIPLE);const a=e[0].parentElement.querySelectorAll("pre");if(0==a.length)throw new h(p.ERROR_FORUM_CONFIG_CODE_SNIPPET_NONE);if(a.length>1)throw new h(p.ERROR_FORUM_CONFIG_CODE_SNIPPET_MULTIPLE);const s=a[0].innerText;return this.parse_forum_configuration(s)}),t,t.time_to_live_s)}parse_forum_configuration(t){try{try{return JSON.parse(t)}catch{-1!=t.indexOf("HermitowskieFejki")&&(t=t.substring(t.indexOf("=")+1)),-1!==t.indexOf(";")&&(t=t.substring(0,t.indexOf(";"))),t=(t=(t=t.replace(/'/g,'"')).replace(/\/\/.*/g,"")).replace(/\/\*.*?\*\//gs,"");return JSON.parse(t)}}catch{throw new h(p.ERROR_FORUM_CONFIG_CODE_SNIPPET_MALFORMED)}}}class v{constructor(e,a,s,i,n){this.data_provider=a,this.map_files=s,this.document=i,this.tribalwars=n,this.game_data=n.getGameData(),t.create_instance(e,(t=>this.logger=t))}async main(t){this.check_screen();const e=await this.get_settings(t),a=await this.map_files.get_world_info([u.config,u.unit_info]);let s=null,i=null;try{s=this.get_troops(a,e),i=await this.get_target(a,e,s)}catch(t){if(e.changing_village_enabled&&t instanceof h){const e=this.document.querySelector("#village_switch_right");e&&(t.href=e.href)}throw t}return this.input_data(s,i)}check_screen(){const t=this.document.querySelector(".jump_link");if(t)throw new h(p.ERROR_SCREEN_VILLAGE_OUT_OF_GROUP,t.href);if("place"!==this.game_data.screen||!this.document.querySelector("#command-data-form")){const t=this.tribalwars.buildURL("GET","place",{mode:"command"});throw new h(p.ERROR_SCREEN_REDIRECT,t)}if(this.document.querySelector("#troop_confirm_go")||this.document.querySelector("#troop_confirm_submit"))throw new h(p.ERROR_SCREEN_NO_ACTION)}async get_settings(t){const e=new x(this.tribalwars,this.map_files);return await e.get_settings(t)}get_troops(t,e){return new m(this.document,t,this.game_data,e).select_troops()}async get_target(t,e,a){const s=new E(t,this.map_files,this.data_provider,this.game_data,e);return await s.select_target(a)}input_data(t,e){for(const e in t)this.document.querySelector(`#unit_input_${e}`).value=t[e]>0?t[e]:"";if(null==e){return p.TROOPS_SELECTED}const a=this.document.querySelector(".target-input-field");a?a.value=`${e.x}|${e.y}`:(this.document.querySelector("#inputx").value=`${e.x}`,this.document.querySelector("#inputy").value=`${e.y}`);let i="";e.player_name&&(i+=e.player_name),e.ally_tag&&(i+=` [${e.ally_tag}]`);return p.TROOPS_AND_TARGET_SELECTED.replace("__DAY__",s(e.arrival_date.getDate())).replace("__MONTH__",s(e.arrival_date.getMonth()+1)).replace("__HOURS__",s(e.arrival_date.getHours())).replace("__MINUTES__",s(e.arrival_date.getMinutes())).replace("__PLAYER_INFO__",i).replace("__TARGET__",`${e.x}|${e.y}`)}}class N{createElement(t){return document.createElement(t)}querySelector(t){return document.querySelector(t)}querySelectorAll(t){return document.querySelectorAll(t)}}class S{getGameData(){return window.game_data}buildURL(t,e,a){return TribalWars.buildURL(t,e,a)}async fetchDocument(t,e,a){const s=this.buildURL(t,e,a),i=await fetch(s),n=await i.text(),r=document.createElement("document");return r.innerHTML=n,r}async fetchJSON(t,e,a){const s=this.buildURL(t,e,a),i=await fetch(s);return await i.json()}}class T{constructor(){this.runtime_timestamp_s=this.get_current_timestamp_s()}get_current_timestamp_s(){return Math.floor(Date.now()/1e3)}get_random_number(t,e){return Math.floor(Math.random()*(e-t)+t)}}!async function(){await d.run("https://forum.plemiona.pl/index.php?threads/hermitowskie-fejki.125294/",(async()=>{const e="Hermitowski.Faking",a=new T,s=await class{static async create_instance(e,a){const s=await class{static async create_instance(e){let a=null;t.create_instance("StorageFactory",(t=>{a=t}));const s=window.indexedDB.open("Hermitowski.Storage",1);s.onupgradeneeded=function(t){const e=t.target.result.createObjectStore(n,{keyPath:r,autoIncrement:!1});e.createIndex(r,r,{unique:!0}),e.createIndex(o,o,{unique:!1})};const l=await i(s);return l.transaction(n,_).objectStore(n).index(o).openCursor(IDBKeyRange.upperBound(e.runtime_timestamp_s)).onsuccess=function(t){const e=t.target.result;e&&(e.delete(),e.continue())},new c(e,l)}}.create_instance(a);return new g(e,s,a)}}.create_instance(e,a),l=new N,u=new S,p=new v(e,a,s,l,u);return await p.main("object"==typeof HermitowskieFejki?HermitowskieFejki:{})}))}()})();